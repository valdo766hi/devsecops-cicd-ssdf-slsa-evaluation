name: Security - Container Scan

on:
  # Best practice: run container image scanning periodically (scheduled)
  # rather than on every PR, to reduce noise and CI cost.
  schedule:
    - cron: "0 0 * * *"  # Daily at 00:00 UTC
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  REGISTRY_USER: ${{ github.repository_owner }}

jobs:
  scan-infra:
    name: Scan Infrastructure Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        image:
          - ghcr.io/emberstack/kubernetes-reflector:10.0.3
          - stakater/reloader:v1.2.1
          - quay.io/argoproj/argocd:v2.13.3
          - docker.io/istio/pilot:1.24.2
          - aquasec/trivy-operator:0.24.1
          - ghcr.io/kyverno/kyverno:v1.13.4
    steps:
      - uses: actions/checkout@v6

      - name: Set up Trivy
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1
        with:
          version: v0.69.1

      - name: Pull image
        run: docker pull ${{ matrix.image }} || true

      - name: Scan image (table + SARIF)
        # Periodic scan is report-only.
        # To enforce later: use `--exit-code 1` and remove any continue-on-error.
        run: |
          set -euo pipefail
          mkdir -p results
          safe=$(echo "${{ matrix.image }}" | tr '/:@' '___')
          echo "${{ matrix.image }}" > "results/${safe}.image.txt"

          trivy image "${{ matrix.image }}" \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            --format table \
            --no-progress | tee "results/${safe}.table.txt"

          trivy image "${{ matrix.image }}" \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            --format sarif \
            --output "results/${safe}.sarif" \
            --no-progress

      - name: Upload SARIF (dynamic)
        if: always() && hashFiles(format('results/{0}.sarif', replace(replace(replace(matrix.image, '/', '_'), ':', '_'), '@', '_'))) != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ format('results/{0}.sarif', replace(replace(replace(matrix.image, '/', '_'), ':', '_'), '@', '_')) }}
          category: ${{ format('container-infra-{0}', replace(replace(replace(matrix.image, '/', '_'), ':', '_'), '@', '_')) }}

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-container-infra-${{ replace(replace(replace(matrix.image, '/', '_'), ':', '_'), '@', '_') }}
          path: results/*
          retention-days: 30

  scan-crapi:
    name: Scan crAPI Images
    runs-on: ubuntu-latest
    permissions:
      packages: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        image:
          - ghcr.io/${{ github.repository_owner }}/crapi-identity:latest
          - ghcr.io/${{ github.repository_owner }}/crapi-community:latest
          - ghcr.io/${{ github.repository_owner }}/crapi-workshop:latest
          - ghcr.io/${{ github.repository_owner }}/crapi-web:latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Trivy
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1
        with:
          version: v0.69.1

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image
        run: docker pull ${{ matrix.image }} || true

      - name: Scan image (table + SARIF)
        # Periodic scan is report-only.
        # To enforce later: use `--exit-code 1` and remove any continue-on-error.
        run: |
          set -euo pipefail
          mkdir -p results
          safe=$(echo "${{ matrix.image }}" | tr '/:@' '___')
          echo "${{ matrix.image }}" > "results/${safe}.image.txt"

          trivy image "${{ matrix.image }}" \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            --format table \
            --no-progress | tee "results/${safe}.table.txt"

          trivy image "${{ matrix.image }}" \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            --format sarif \
            --output "results/${safe}.sarif" \
            --no-progress

      - name: Upload SARIF (dynamic)
        if: always() && hashFiles(format('results/{0}.sarif', replace(replace(replace(matrix.image, '/', '_'), ':', '_'), '@', '_'))) != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ format('results/{0}.sarif', replace(replace(replace(matrix.image, '/', '_'), ':', '_'), '@', '_')) }}
          category: ${{ format('container-crapi-{0}', replace(replace(replace(matrix.image, '/', '_'), ':', '_'), '@', '_')) }}

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-container-crapi-${{ replace(replace(replace(matrix.image, '/', '_'), ':', '_'), '@', '_') }}
          path: results/*
          retention-days: 30

  report-summary:
    name: Summary (Affected Images)
    runs-on: ubuntu-latest
    needs: [scan-infra, scan-crapi]
    permissions:
      contents: read
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Build summary table
        run: |
          python3 - <<'PY'
          import os
          import re
          from pathlib import Path

          def parse_table_counts(path: Path):
            # Example: Total: 1 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 1, CRITICAL: 0)
            text = path.read_text(encoding='utf-8', errors='replace')
            m = re.search(r"Total:\s*\d+\s*\(.*?HIGH:\s*(\d+).*?CRITICAL:\s*(\d+).*?\)", text, re.DOTALL)
            if not m:
              return None
            return (int(m.group(2)), int(m.group(1)))  # (critical, high)

          # Map safe filename -> original image ref
          img_map = {}
          for p in Path('artifacts').rglob('*.image.txt'):
            safe = p.name.replace('.image.txt', '')
            img_map[safe] = p.read_text(encoding='utf-8', errors='replace').strip()

          rows = []
          for p in Path('artifacts').rglob('*.table.txt'):
            safe = p.name.replace('.table.txt', '')
            counts = parse_table_counts(p)
            if not counts:
              continue
            crit, high = counts
            if not (crit or high):
              continue
            img = img_map.get(safe, safe)
            group = ''
            # Determine group from artifact directory name
            for part in p.parts:
              if part.startswith('trivy-container-infra-'):
                group = 'infra'
                break
              if part.startswith('trivy-container-crapi-'):
                group = 'crapi'
                break
            rows.append((group, img, crit, high))

          print('## Daily Container Scan - Affected Images (CRITICAL/HIGH)')
          print('')
          print(f"Code Scanning: https://github.com/{os.environ.get('GITHUB_REPOSITORY','')}/security/code-scanning")
          print('')
          if not rows:
            print('No CRITICAL/HIGH findings detected in scanned images.')
            raise SystemExit(0)
          rows.sort(key=lambda r: (r[0], r[1]))
          print('| Group | Image | CRITICAL | HIGH |')
          print('|---|---|---:|---:|')
          for group, img, crit, high in rows:
            g = group or '-'
            print(f'| {g} | {img} | {crit} | {high} |')
          PY >> "$GITHUB_STEP_SUMMARY"
