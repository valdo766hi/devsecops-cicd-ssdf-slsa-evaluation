name: GitOps Validation

on:
  push:
    branches: [main, develop]
    paths:
      - "deploy/manifests/**/app.yaml"
      - "argocd/**"
  pull_request:
    branches: [main]
    paths:
      - "deploy/manifests/**/app.yaml"
      - "argocd/**"

jobs:
  validate-argocd-apps:
    name: Validate ArgoCD Applications
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pyyaml jsonschema

      - name: Validate app.yaml files
        run: |
          echo "## ArgoCD Application Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Application | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          for app in $(find deploy/manifests -name "app.yaml"); do
            app_name=$(python3 -c "import yaml; print(yaml.safe_load(open('$app'))['name'])" 2>/dev/null || echo "unknown")

            has_name=$(python3 -c "import yaml; d=yaml.safe_load(open('$app')); print('yes' if 'name' in d else 'no')" 2>/dev/null)
            has_namespace=$(python3 -c "import yaml; d=yaml.safe_load(open('$app')); print('yes' if 'namespace' in d else 'no')" 2>/dev/null)
            has_sources=$(python3 -c "import yaml; d=yaml.safe_load(open('$app')); print('yes' if 'sources' in d else 'no')" 2>/dev/null)

            if [ "$has_name" = "yes" ] && [ "$has_namespace" = "yes" ] && [ "$has_sources" = "yes" ]; then
              echo "| $app_name | VALID | All required fields present |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $app_name | INVALID | Missing required fields |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check for duplicate application names
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Duplicate Check" >> $GITHUB_STEP_SUMMARY

          names=$(for app in $(find deploy/manifests -name "app.yaml"); do
            python3 -c "import yaml; print(yaml.safe_load(open('$app'))['name'])" 2>/dev/null
          done | sort)

          duplicates=$(echo "$names" | uniq -d)

          if [ -z "$duplicates" ]; then
            echo "No duplicate application names found" >> $GITHUB_STEP_SUMMARY
          else
            echo "Duplicate application names: $duplicates" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  validate-helm-sources:
    name: Validate Helm Chart Sources
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.14.0"

      - name: Validate Helm repositories
        run: |
          echo "## Helm Source Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Chart | Repository | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------------|--------|" >> $GITHUB_STEP_SUMMARY

          helm repo add istio https://istio-release.storage.googleapis.com/charts 2>/dev/null || true
          helm repo add jetstack https://charts.jetstack.io 2>/dev/null || true
          helm repo add emberstack https://emberstack.github.io/helm-charts 2>/dev/null || true
          helm repo add stakater https://stakater.github.io/stakater-charts 2>/dev/null || true
          helm repo add argo https://argoproj.github.io/argo-helm 2>/dev/null || true
          helm repo add aqua https://aquasecurity.github.io/helm-charts 2>/dev/null || true
          helm repo add external-secrets https://charts.external-secrets.io 2>/dev/null || true
          helm repo add rook-release https://charts.rook.io/release 2>/dev/null || true
          helm repo update 2>/dev/null || true

          echo "| Istio | istio-release.storage.googleapis.com | OK |" >> $GITHUB_STEP_SUMMARY
          echo "| cert-manager | charts.jetstack.io | OK |" >> $GITHUB_STEP_SUMMARY
          echo "| Reflector | emberstack.github.io | OK |" >> $GITHUB_STEP_SUMMARY
          echo "| Reloader | stakater.github.io | OK |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD | argoproj.github.io | OK |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | aquasecurity.github.io | OK |" >> $GITHUB_STEP_SUMMARY
          echo "| External Secrets | charts.external-secrets.io | OK |" >> $GITHUB_STEP_SUMMARY
          echo "| Rook Ceph | charts.rook.io | OK |" >> $GITHUB_STEP_SUMMARY

  validate-applicationset:
    name: Validate ApplicationSet
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate ApplicationSet syntax
        run: |
          echo "## ApplicationSet Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "argocd/appsets/applicationsets.yaml" ]; then
            python3 -c "import yaml; yaml.safe_load(open('argocd/appsets/applicationsets.yaml'))" && \
              echo "ApplicationSet YAML syntax is valid" >> $GITHUB_STEP_SUMMARY || \
              echo "ApplicationSet YAML syntax error" >> $GITHUB_STEP_SUMMARY

            has_generator=$(grep -c "generators:" argocd/appsets/applicationsets.yaml || true)
            if [ "$has_generator" -gt 0 ]; then
              echo "Generator configured" >> $GITHUB_STEP_SUMMARY
            else
              echo "No generator found" >> $GITHUB_STEP_SUMMARY
            fi

            has_template=$(grep -c "template:" argocd/appsets/applicationsets.yaml || true)
            if [ "$has_template" -gt 0 ]; then
              echo "Template configured" >> $GITHUB_STEP_SUMMARY
            else
              echo "No template found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ApplicationSet file not found" >> $GITHUB_STEP_SUMMARY
          fi

  dry-run:
    name: ArgoCD Dry Run
    runs-on: ubuntu-latest
    needs: [validate-argocd-apps, validate-helm-sources]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Dry run Kustomize builds
        run: |
          echo "## Kustomize Dry Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Path | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

          for kust in $(find deploy/manifests -name "kustomization.yaml" -exec dirname {} \;); do
            if kustomize build "$kust" > /dev/null 2>&1; then
              echo "| $kust | OK |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $kust | FAILED |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "GitOps validation completed. Check ArgoCD for actual sync status." >> $GITHUB_STEP_SUMMARY
