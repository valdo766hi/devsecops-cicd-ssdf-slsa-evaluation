name: Container Image Security Scan

on:
  push:
    branches: [main]
    paths:
      - "deploy/manifests/crapi/**"
  pull_request:
    branches: [main]
    paths:
      - "deploy/manifests/crapi/**"
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  scan-crapi-images:
    name: Scan crAPI Images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - crapi/crapi-identity:latest
          - crapi/crapi-community:latest
          - crapi/crapi-workshop:latest
          - crapi/crapi-web:latest
          - mailhog/mailhog:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull container image
        run: docker pull ${{ matrix.image }} || echo "Failed to pull ${{ matrix.image }}"

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: "sarif"
          output: "trivy-image-${{ strategy.job-index }}.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          vuln-type: "os,library"

      - name: Upload scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-image-${{ strategy.job-index }}.sarif"
          category: "trivy-${{ matrix.image }}"

      - name: Run Trivy scan (table output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: "table"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

  scan-infra-images:
    name: Scan Infrastructure Images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - ghcr.io/emberstack/kubernetes-reflector:10.0.3
          - stakater/reloader:v1.2.1
          - quay.io/argoproj/argocd:v2.13.3
          - docker.io/istio/pilot:1.24.2
          - aquasec/trivy-operator:0.24.1
          - ghcr.io/kyverno/kyverno:v1.13.4
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull container image
        run: docker pull ${{ matrix.image }} || echo "Failed to pull ${{ matrix.image }}"

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: "sarif"
          output: "trivy-infra-${{ strategy.job-index }}.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-infra-${{ strategy.job-index }}.sarif"
          category: "trivy-infra-${{ strategy.job-index }}"

  vulnerability-report:
    name: Generate Vulnerability Report
    runs-on: ubuntu-latest
    needs: [scan-crapi-images, scan-infra-images]
    if: always()
    steps:
      - name: Generate summary report
        run: |
          echo "## Container Image Vulnerability Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### crAPI Images" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| crapi/crapi-identity | ${{ needs.scan-crapi-images.result == 'success' && 'SCANNED' || 'CHECK REQUIRED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| crapi/crapi-community | ${{ needs.scan-crapi-images.result == 'success' && 'SCANNED' || 'CHECK REQUIRED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| crapi/crapi-workshop | ${{ needs.scan-crapi-images.result == 'success' && 'SCANNED' || 'CHECK REQUIRED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| crapi/crapi-web | ${{ needs.scan-crapi-images.result == 'success' && 'SCANNED' || 'CHECK REQUIRED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Images" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| kubernetes-reflector | ${{ needs.scan-infra-images.result == 'success' && 'SCANNED' || 'CHECK REQUIRED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| reloader | ${{ needs.scan-infra-images.result == 'success' && 'SCANNED' || 'CHECK REQUIRED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| argocd | ${{ needs.scan-infra-images.result == 'success' && 'SCANNED' || 'CHECK REQUIRED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| istio | ${{ needs.scan-infra-images.result == 'success' && 'SCANNED' || 'CHECK REQUIRED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| kyverno | ${{ needs.scan-infra-images.result == 'success' && 'SCANNED' || 'CHECK REQUIRED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in the Security tab" >> $GITHUB_STEP_SUMMARY
